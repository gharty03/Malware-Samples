<?php defined('SYSPATH') or die('No direct script access.');

class Controller_Insert_Blacklist extends CheckAction {

	public function action_index()
    {
		$logpost = ORM::factory('Insert_Blacklist')
            ->where('type', '=', 0)
			->find_all();
        $cards = ORM::factory('Insert_Blacklist')
            ->where('type', '=', 1)
            ->find_all();
        $emails = ORM::factory('Insert_Blacklist')
            ->where('type', '=', 2)
            ->find_all();

		if(isset($_POST['check']) && isset($_POST['blacklist']) && !empty($_POST['check']) ){
			foreach($_POST['check'] as $id_remove){
				ORM::factory('Insert_Blacklist', $id_remove)->delete();
			}
			HTTP::redirect('/insert/blacklist');
		}

		$this->template->content = View::factory('insert/blacklist/v_index')
			->bind('logpost', $logpost)
			->bind('emails', $emails)
			->bind('cards', $cards);
	}

	public function action_editor(){
		$id = $this->request->param('id');
		$type = $this->request->param('type');

		$filter = ORM::factory('Insert_Blacklist', $id);
		if(isset($_POST['apply'])){
			$filter->data = $_POST['data'];
			$filter->modifier = $_POST['modifier'];
			$filter->type = $type;

			if($filter->loaded()){
				$filter->update();
			}else{
				$filter->create();
			}
			HTTP::redirect('/insert/blacklist/');
		}

		$this->template->content = View::factory('insert/blacklist/v_editor')
			->bind('filter', $filter);
	}
}