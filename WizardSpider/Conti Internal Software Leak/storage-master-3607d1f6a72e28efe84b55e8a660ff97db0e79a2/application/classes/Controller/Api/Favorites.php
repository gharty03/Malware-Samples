<?php defined('SYSPATH') or die('No direct script access.');

class Controller_Api_Favorites extends Controller {
		
	protected function user_favorites(){
		$favorites_sql = DB::select('user_id', 'client_id')
        ->from('favorites')
        ->where('user_id', '=', Auth::instance()->get_user()->id)
        ->execute()
        ->as_array();
        $clients_arr = [];
        foreach ($favorites_sql as $favorites){
            $clients_arr[] = $favorites['client_id'];
        } 
        return $clients_arr;                      
	}
		
    public function action_logpost(){
    	if(!empty($_POST['client_id'])){
    		$client_in =  [$_POST['client_id']];
    	}
    	else{
    		$client_in = count($this->user_favorites()) > 0 ? $this->user_favorites() : [0];
    	}
    	   	
        $logpost_arr = DB::select('*')
        ->from('logpost')
        ->where('client_id', 'IN', $client_in)
        ->order_by('datetime', 'DESC')
        ->execute()->as_array();
        if(count($logpost_arr) > 0){                 
			$this->response->body(
	            json_encode($logpost_arr)
	        );
		}
   	}  
    
    public function action_clients(){
        $client_arr = DB::select('*')
        ->from('clients')
        ->where('id', 'IN', count($this->user_favorites()) > 0 ? $this->user_favorites() : [0])
        ->execute()
        ->as_array();
        if(count($client_arr) > 0){                 
			$this->response->body(
	            json_encode($client_arr)
	        );
		}
    }  
      
}
