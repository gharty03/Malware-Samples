<?php defined('SYSPATH') or die('No direct script access.');

class Task_Api_Client extends Minion_Task {

    private $transport = 'sslv3';
    private $port = '9908';
//    private $ip = '193.203.48.56';
    private $ip = '85.25.217.84';

    private $client = 'D6C3591451C77CD35D8D60070DA17A27';

    protected function _execute(array $params){
        $context = stream_context_create([
            'ssl' => [
                'local_cert' => '/root/crt/clients/test.pem',
            ]
        ]);

        $socket = stream_socket_client(
            $this->transport.'://'.$this->ip.':'.$this->port,
            $errno,
            $errstr,
            10,
            STREAM_CLIENT_CONNECT,
            $context
        );

        if (!$socket) {
            Minion_CLI::write($errstr, $errno);
        } else {

            $data = json_encode([
                'client_id' => $this->client,
                'tor' => false,
                'method' => 'info'
            ]);

//            $data = json_encode([
//                'method' => 'online'
//            ]);

            fwrite($socket, $data);

            while (!feof($socket)) {
                echo fgets($socket, 1024);
            }

            fclose($socket);
        }
    }
}