<?php defined('SYSPATH') or die('No direct script access.');

class Task_Parser_Referrer_Merge extends Minion_Task{

	protected function _execute(array $params){
		$files = glob("/root/*.txt");
		Minion_CLI::write('FINDED: '.count($files));
		$result = array();
		foreach($files as $f){
			$strings = file($f);
			$result = array_merge($result, $strings);
		}

		$new_result = array_unique($result);
		$file_name = Text::random(null, 15);

		foreach($new_result as $r){
			file_put_contents('/root/'.$file_name.'.txt', $r."\n", FILE_APPEND);
		}

		Minion_CLI::write('FILENAME: '.$file_name);
		$password = Text::random(null, 15);
		Minion_CLI::write('PASSWORD: '.$password);
		exec(
			"cd /root/ && ".
			"zip --password ".$password." ".$file_name.".zip ".$file_name.".txt && ".
			"mv ".$file_name.".zip /var/www/"
		);

		unlink('/root/'.$file_name.'.txt');

		Minion_CLI::write("LINK: https://".Kohana::$config->load('init.local_info.ip')."/".$file_name.".zip");
	}
}