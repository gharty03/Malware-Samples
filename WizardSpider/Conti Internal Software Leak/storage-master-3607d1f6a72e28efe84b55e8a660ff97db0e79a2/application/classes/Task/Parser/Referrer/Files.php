<?php defined('SYSPATH') or die('No direct script access.');

class Task_Parser_Referrer_Files extends Minion_Task{

    protected function _execute(array $params){
	    $old_array = array_filter(file('/root/H38Mv9UZxxWM7Di.txt'));
	    $new_array = $old_array;

	    foreach($old_array as $k => $v){
		    $url = parse_url($v);
	        foreach($new_array as $k2 => $v2){
		        $url2 = parse_url($v2);
		        if(isset($url2['host']) && isset($url['host']) && $url2['host'] == $url['host'] && $url2['path'] == $url['path']){
			        $new_url = $url['host'].$url['path'].'?*';
			        $new_array[$k] = $new_url;
			        unset($new_array[$k2]);
		        }
	        }
	    }

	    foreach($new_array as $k => $v){
		    $new_array[$k] = str_replace(["\r", "\n"], '', $v);
	    }

	    $new_array = array_filter($new_array);

	    $file_name = Text::random(null, 15);
	    Minion_CLI::write($file_name);
	    foreach($new_array as $r){
		    file_put_contents('/root/'.$file_name.'.txt', $r."\n", FILE_APPEND);
	    }
    }
}