<?php defined('SYSPATH') or die('No direct script access.');

class Task_Parser_Bank2 extends Minion_Task{
    protected function _execute(array $params)
    {
        $my_words = [
            'fanucrobotics'
        ];

        foreach($my_words as $key_word){
            $query = $this->getQuery($key_word);
            $fp = fopen('/home/bank/'.$key_word.'.csv', 'w');
            foreach($query as $item){
                $tmp_array = array();
                foreach($item as $key => $item2){
                    if($key != 'data'){
                        $tmp_array[] = $item2;
                    }else{
                        $data_string = '';
                        $data = json_decode($item2, true);
                        foreach($data as $k => $d){
                            $data_string .= $k.": ".$d."\n\r";
                        }
                        $tmp_array[] = $data_string;
                    }
                }
                fputcsv($fp, $tmp_array);
            }

            fclose($fp);
        }
    }

    private function getQuery($key_word){
        return DB::select('l.id', 't.client', 'l.referrer', 'l.link', 'l.datetime', 'l.data')
            ->from(['logpost', 'l'])
            ->join(['test', 't'])
            ->on('l.test_id', '=', 't.id')
            ->where('l.data', 'LIKE', '%'.$key_word.'%')
            ->execute()
            ->as_array();
    }
}