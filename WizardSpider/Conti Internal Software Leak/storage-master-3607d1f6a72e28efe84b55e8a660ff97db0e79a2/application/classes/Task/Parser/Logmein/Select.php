<?php defined('SYSPATH') or die('No direct script access.');

class Task_Parser_Logmein_Select extends Minion_Task{
    protected function _execute(array $params)
    {
        $list = json_decode(
            file_get_contents('/home/logmein2/list.txt'),
            true
        );

        $list_ready = scandir('/home/logmein2/');
        $clients = null;
        foreach($list_ready as $k => $v){
            if(!in_array($v, ['.', '..', 'list.txt'])){
                $clients[] = pathinfo($v, PATHINFO_FILENAME);
            }
        }

        foreach($list as $k => $v){
            if(in_array($v['client'], $clients)){
                unset($list[$k]);
            }
        }

        $client = Task_Helper::getClient();
        foreach ($list as $l) {
            $data = json_encode($l);
            $client->addTaskHighBackground('Logmein', $data, null, md5($data));
        }
        $client->runTasks();
    }
}