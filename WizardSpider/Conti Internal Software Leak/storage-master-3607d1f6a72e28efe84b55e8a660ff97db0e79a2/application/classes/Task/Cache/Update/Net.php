<?php defined('SYSPATH') or die('No direct script access.');

class Task_Cache_Update_Net extends Minion_Task
{
    
	protected function _execute(array $params)
    {
        $counter = ORM::factory('Counter', 'cache_nets:client_id');
        $counter->name = 'cache_nets:client_id';
        $client_id = (int)$counter->id;
        
        for($i = 0; $i < 1000; ++$i)
        {
            $client = ORM::factory('Client')
               ->where('id', '>', $client_id)
               ->find();
            
            if ( ! $client->loaded() )
            {
                break;
            }
            
            $cache_net = ORM::factory('Cache_Net')
                ->where('name', '=', $client->net)
                ->find();
            
            $cache_net->name = $client->net;
            $cache_net->save();
            
            $client_id++;
        }
        
        $counter->id =  $client_id;
        $counter->save();
        
        sleep(60);
    }
    
}