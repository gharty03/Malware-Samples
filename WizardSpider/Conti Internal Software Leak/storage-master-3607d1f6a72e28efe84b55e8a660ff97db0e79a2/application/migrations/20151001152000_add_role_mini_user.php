<?php defined('SYSPATH') or die('No direct script access.');

class Add_role_mini_user extends Migration
{
    // TODO FIX IT
    public function up()
    {
        $role_mini_user = ORM::factory('Role');
        $role_mini_user->name = 'mini-user';
        $role_mini_user->description = 'Have access only to /logpost/more_ex/:id and /logpost/more/:id';
        $role_mini_user->save();

        $roles = ORM::factory('Role')->find_all();
        
        $action = ORM::factory('Action');
        $action->name = 'Logpost/More_ex';
        $action->description = 'View logposts of client';
        $action->menu_title = '';
        $action->save();
        
        foreach($roles as $role) {
            $role->add('actions', $action);
        } unset($role);
        
        $action = ORM::factory('Action');
        $action->name = 'Logpost/More';
        $action->description = 'View logpost by id';
        $action->menu_title = '';
        $action->save();
        foreach($roles as $role) {
            $role->add('actions', $action);
        } unset($role);
    }

    public function down()
    {
        $actionLogpostMore = ORM::factory('Action', ['name' => 'Logpost/More']);
        $actionLogpostMore_ex = ORM::factory('Action', ['name' => 'Logpost/More_ex']);
        
        $roles = ORM::factory('Role')->find_all();
        foreach($roles as $role) {
            $role->remove('actions', $actionLogpostMore);
            $role->remove('actions', $actionLogpostMore_ex);
        } unset($role);
        
        $actionLogpostMore->delete();
        $actionLogpostMore_ex->delete();
        
        $role_mini_user = ORM::factory('Role', ['name' => 'mini-user']);
        $role_mini_user->remove('users');
        $role_mini_user->delete();
    }
}