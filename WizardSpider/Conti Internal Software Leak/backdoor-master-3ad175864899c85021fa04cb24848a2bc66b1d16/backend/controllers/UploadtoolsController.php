<?php

namespace backend\controllers;

use Yii;
use yii\web\Controller;
use yii\web\Response;
use backend\models\Attachmentstools;
use common\models\Files;
use yii\db\Expression;
use yii\helpers\Json;
class UploadtoolsController extends Controller
{
	public function actionIndex()
    {
	if (Yii::$app->user->isGuest) {
        return $this->goHome();
    }
    $group = Yii::$app->request->queryParams['group'];

    if (isset($_POST)) {
    	if (isset($_FILES)){
    		$files= Attachmentstools::SaveTempAttachments($_FILES);
            $result = ['files'=>$files];
            
            foreach ($result as $k => $val) {
            	foreach ($result[$k] as $key => $value) {
            		$i = 0;
	            	$m = new Files();
	            	$m->storedfilename = $value['fileName'];
	            	$m->filetype = $value['type'];
	            	$m->size = (int)$value['size'];
	            	$m->filename = $value['originalName'];
	            	$m->created_at = new Expression('NOW()');
                    $m->hashmd5 = $value['hash'];
                    $m->group = $group;
                    $m->admin_id = Yii::$app->user->identity->id;
	            	$m->save(false);

                    $result['files'][$i]['id'] = $m->id;
                    $result['files'][$i]['uploaded'] = $m->created_at;
                            

                    Yii::info('Admin '. Yii::$app->user->identity->login . ' upload file ' . $m->filename, $category = 'admininfo');
		            
	            }
            }

            
            Yii::$app->response->format = trim(Response::FORMAT_JSON);
            return $result;
        }
    }
    }
}