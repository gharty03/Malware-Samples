
function initpacketcommand(){
	var comm = $('#packedtasks-field21').val();
	var tabs = ['setvarname', 'setvarvalue', 'getvarvalue1', 'getvarvalue2', 'condition', 'gotoline'];

	// set default all invisibles
	for(i=0;i<tabs.length;i++){
		$('#'+tabs[i]).addClass('hidetab');
	}

	
	// show tabs
	switch(comm){
		case 'runbot':
			$('#setvarname').removeClass('hidetab');
			$('#setvarname-label').text('Put result to variable');
			break;

		case 'setvar':
			$('#setvarname').removeClass('hidetab');
			$('#setvarvalue').removeClass('hidetab');
			$('#setvarname-label').text('Variable name');
			$('#setvarvalue-label').text('Variable value');
			break;

		case 'ifgoto':
			$('#getvarvalue1').removeClass('hidetab');
			$('#condition').removeClass('hidetab');
			//$('#getvarvalue2').removeClass('hidetab');
			$('#gotoline').removeClass('hidetab');
			$('#getvarvalue1-label').text('Variable');
			break;
		
		case 'ifexit':
			$('#getvarvalue1').removeClass('hidetab');
			$('#condition').removeClass('hidetab');
			//$('#getvarvalue2').removeClass('hidetab');
			break;
		
		case 'increment':
			$('#getvarvalue1').removeClass('hidetab');
			$('#setvarname-label').text('Variable name');
			break;

		case 'decrement':
			$('#getvarvalue1').removeClass('hidetab');
			$('#setvarname-label').text('Variable name');
			break;

		
		default:
			break;	
	
	}
	buildpacketcommand();
}

function buildpacketcommand(){
	// trigger = change any field or click GO
	
	var i = 0;
	// clear fields
	for (var n = 22; n <= 27; n++) {
		//$('#packedtasks-field'+n).val('');
	}
	// set values from tabs
	$('.selectpacketcommand').each(function(){
		if(!$(this).parent().parent().hasClass('hidetab')){
			if($(this).val()!=null){
				
				//$('#packedtasks-field'+i).val($(this).val());
			}
		}
		i++;
	});
	
}


$('#packedtasks-field25').on('change', function(e) { // disable masks on create

    // selected values
    var vals = $(this).select2("val");

    if(vals == 'isnull' || vals == 'isnotnull'){
    	$('#getvarvalue2').addClass('hidetab');
    }else{
    	$('#getvarvalue2').removeClass('hidetab');
    }

});

/*function repeatCommand(c){
	var comm = JSON.parse(c);

	// fix scripts
	if(comm[0]=='runbat' || comm[0]=='runpws'){
		var quote = comm[6].replace(/singlequotevk1zyS5/g, "'");
		var slash = quote.replace(/slashslash743io/g, "\\");
		var tab = slash.replace(/tabtab847264y/g, "\t");
		comm[6] = tab;
	}

	// set up menus
	$('#commandtype').val(comm[0]).trigger('change');
	$('#selectruntype').val(comm[1]).trigger('change');
	$('#timeoutselect').val(comm[2]).trigger('change');
	$('#selectmask').val(comm[3]).trigger('change');
	$("#selectFileUpLoad option").each(function() {
		this.selected = (this.text == comm[7]); 
	}).trigger('change');
	$('#cmd').val(comm[5]);
	$('#script').html(comm[6]);

	// fill fields
	
	for (var i = 0; i <= 7; i++) {
		$('#packedtasks-field'+i).val(comm[i].trim());
	}
	
}*/



$("body").on( "mouseover", "#select2-selectFileUpLoad-results .select2-results__option", function(){
	var d = $(this).children().attr("class");
	var p = jQuery.inArray( d, file_attr );
	var res = '';
	res += "<a href='javascript:refreshfilelist()'>Refresh file list</a><br>";
	if(p >= 0){
		file_dd = file_attr[p];
		res += "<b>Name:</b>"+file_attr[p+1]+"<br>";
		res += "<b>Size:</b>"+file_attr[p+2]+"<br>";
		res += "<b>Uploaded:</b>"+file_attr[p+3]+"<br>";
		res += "<b>By user: </b> "+file_attr[p+5]+"<br>";
		res += "<b>Hash:</b>"+file_attr[p+4]+"<br>";
		res += "<a href='javascript:itemdeletedialogue()'>Delete this file</a>&nbsp;&nbsp;";
		
	}

	if($("#advanced-fileinfo").length==0){
		$( "<div id='advanced-fileinfo'>Test</div>" ).insertBefore( ".select2-search--dropdown" );
	}
	$("body #advanced-fileinfo").html(res);
	
} );

function autorefreshChanged(a){
	alert(a)
	/*$.ajax({
	  method: "POST",
	  async: false,
	  url: "/bots/autorefreshchanged?id="+id
	});*/
}


function itemdeletedialogue(){
	$("#fastdeletemodalmask").show();
	$("#fastdeletemodal").show();
}

$("#fastdeletemodalcancel").click(function(){
	$("#fastdeletemodalmask").hide();
	$("#fastdeletemodal").hide();
});

$("#fastdeletemodalclose").click(function(){
	$("#fastdeletemodalmask").hide();
	$("#fastdeletemodal").hide();
});

$("#fastdeletemodalok").click(function(){
	$("#fastdeletemodalmask").hide();
	$("#fastdeletemodal").hide();
	itemdelete(file_dd);
});

function itemdelete(item){
	// delete from select
	$('#selectFileUpLoad option[value="'+item+'"]').remove().trigger('change');
	
	// delete from file_attr array
	var j = file_attr.indexOf(item)
	var id = file_attr[j+6];
	file_attr.splice(j,7);
	
	// delete file
	$.ajax({
	  method: "POST",
	  async: false,
	  url: "/files/delete?id="+id
	});
}

function doublefiledialogue(p0,p1,p2,p3,p4,p5,p6){
	$("#doublefilemodalmask").show();
	$("#doublefilemodal").show();
	var res = '';
	res += "<b>Name:</b>"+p4+"<br>";
	res += "<b>Size:</b>"+p3+"<br>";
	res += "<b>Uploaded:</b>"+p6+"<br>";
	res += "<b>By user: </b> "+p2+"<br>";
	res += "<b>Hash:</b>"+p5+"<br>";
	$("body #doublefileinfo").html(res);
}

$("#doublefilemodalcancel").click(function(){
	$("#doublefilemodalmask").hide();
	$("#doublefilemodal").hide();
});

$("#fastdeletemodalclose").click(function(){
	$("#doublefilemodalmask").hide();
	$("#doublefilemodal").hide();
	itemdelete(last_id);
});

$("#doublefilemodalok").click(function(){
	$("#doublefilemodalmask").hide();
	$("#doublefilemodal").hide();
});

$('#mainform').submit(function(){
	if($('#packedtasks-field0').val()=='runexe' || $('#packedtasks-field0').val()=='rundll' || $('#packedtasks-field0').val()=='updatenow' || $('#packedtasks-field0').val()=='updatebot64' || $('#packedtasks-field0').val()=='updatebot86' || $('#packedtasks-field0').val()=='updateloader64' || $('#packedtasks-field0').val()=='updateloader86'){
		if($('#packedtasks-field4').val()=='' || $('#packedtasks-field4').val()=='nofile'){
			$("#errormodalmask").show();
			$("#errormodal").show();
			return false;
		}
	}
	if($('#packedtasks-field0').val()=='runbat' || $('#packedtasks-field0').val()=='runpws' || $('#packedtasks-field0').val()=='runcode'){
		if($('#packedtasks-field6').val()==''){
			$("#errormodalmask").show();
			$("#errormodal").show();
			return false;
		}
	}
});

$("#errormodalcancel").click(function(){
	$("#errormodalmask").hide();
	$("#errormodal").hide();
});


function refreshfilelist(){
	$.ajax({
	  method: "POST",
	  dataType: "json",
	  url: "/files/getgroupfiles?id="+$('#botgroup').text(),
	  success:function(data){
	  	
	  	var result = Object.keys(data).map(function(key) {
		  return [Number(key), data[key]];
		});

	  	// clear previous options
	  	file_attr = new Array();
		$('#selectFileUpLoad option').each(function(){
			$("#selectFileUpLoad option[value='"+$(this).val()+"']").remove().trigger('change');
		});

		// Create first option
		var data = { id: 'nofile', text: '...'	};
		var newOption = new Option(data.text, data.id, false, false);
		$('#selectFileUpLoad').append(newOption).trigger('change');

		var res = '';
		for (var i = 0; i < result.length; i++) {

			// new file list create
			s = result[i];
			for (var j = 0; j < s[1].length; j++) {
				file_attr.push(s[1][j]); 
		  	}

		  	// add new file list item
			var data = { id: s[1][0], text: s[1][1]	};
			var newOption = new Option(data.text, data.id, false, false);
			$('#selectFileUpLoad').append(newOption).trigger('change');
		
	  	}
	  	$('#selectFileUpLoad').val('nofile').trigger('change');
	  }
	});
}
