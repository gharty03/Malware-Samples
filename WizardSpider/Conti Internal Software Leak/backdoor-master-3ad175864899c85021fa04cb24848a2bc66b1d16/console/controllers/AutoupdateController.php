<?php

namespace console\controllers;

use yii\console\Controller;
use Yii;
use common\models\Bots;
use common\models\Commands;
use yii\db\Expression;

class AutoupdateController extends Controller
{
    public function actionIndex()
    {
    	// select bots with autoupdate option
        $b = Bots::find()->andFilterWhere(['>','autoupdate',0])->asArray()->all();

        $time = new \DateTime('NOW');
        $now = $time->format('Y-m-d H:i:s');

        foreach ($b as $key => $value) {
            if(strtotime(gmdate('Y-m-d H:i:s',strtotime($now)))-(strtotime($value['update_start'])+(60 * 60 * $value['autoupdate'])) >= 0){
                $c = New Commands();
                $c->created_at = new Expression('NOW()');
                $c->bot_id = $value['id'];
                $c->command = '10 4';
                $c->status = 0;
                $c->admin = 0;
                $c->commandtype = 10;
                $c->usercommand = 'updatenow    update                      ...';
                $c->ip = $value['ip'];
                $c->group = $value['group'];
                $c->save(false);

                $d = Bots::findOne(['id' => $value['id']]);
                $d->update_start = new Expression('NOW()');
                $d->save(false);

            }
            // echo strtotime(gmdate('Y-m-d H:i:s',strtotime($now)))-(strtotime($value['update_start'])+(60 * 60 * $value['autoupdate']));
            
        }

        
        
        exit();
    }

}
