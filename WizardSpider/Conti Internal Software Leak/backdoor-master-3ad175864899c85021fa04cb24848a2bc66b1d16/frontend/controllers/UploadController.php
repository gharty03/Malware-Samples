<?php

namespace frontend\controllers;

use Yii;
use yii\web\Controller;
use yii\web\Response;
use frontend\models\Attachments;
use common\models\Files;
use yii\db\Expression;
use yii\helpers\Json;
class UploadController extends Controller
{
	public function actionIndex()
    {
	if (Yii::$app->user->isGuest) {
        return $this->goHome();
    }
    if (isset($_POST)) {
    	if (isset($_FILES)){
    		$files= Attachments::SaveTempAttachments($_FILES);
            $result = ['files'=>$files];
            
            foreach ($result as $k => $val) {
            	foreach ($result[$k] as $key => $value) {
            		if($value['type']!='bat' && $value['type']!='pws'){ // bat & pws are not keeping
		            	$m = new Files();
		            	$m->storedfilename = $value['fileName'];
		            	$m->filetype = $value['type'];
		            	$m->size = (int)$value['size'];
		            	$m->filename = $value['originalName'];
		            	$m->created_at = new Expression('NOW()');
		            	$m->admin_id = Yii::$app->user->identity->id;
		            	$m->save(false);
                        Yii::info('User '. Yii::$app->user->identity->username . ' upload file '.$m->filename, $category = 'userinfo');
		            }
	            }
            }

            
            Yii::$app->response->format = trim(Response::FORMAT_JSON);
            return $result;
        }
    }
    }
}