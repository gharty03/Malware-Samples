#!/bin/bash

#
# Warning! High CPU usage.
#
# Usage:
#
#     FROM_HOST=188.138.102.36 TO_HOST=172.98.203.70 ./copy_indexes2.sh
#

if [[ "$FROM_HOST" == "" || "$TO_HOST" == "" ]]; then
    echo "Please provide \$FROM_HOST and \$TO_HOST"
    exit 1
fi

apt-get install -y pigz openssl nc pv
ssh $TO_HOST "apt-get install -y pigz openssl nc"
ssh $TO_HOST "mkdir -p /home/new_sphinx"

ENCRYPTION_KEY=$(openssl rand 16 | hexdump -e '16/1 "%02x"')
IV=$(( RANDOM % 10 ))

screen -S "scp1" -d -m
screen -r scp1 -X stuff "tar -cf - -C /home/new_sphinx . | pv -s $(du -sb /home/new_sphinx | cut -f1) | pigz | openssl enc -aes-128-cbc -e -iv $IV -K $ENCRYPTION_KEY | nc -l -p 8889 -q 0\n"
screen -S "scp2" -d -m
screen -r scp2 -X stuff "ssh $TO_HOST \"nc $FROM_HOST 8889 | openssl enc -aes-128-cbc -d -iv $IV -K $ENCRYPTION_KEY | pigz -d | tar -xf - -C /home/new_sphinx\"\n"
